<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Verifying...</title>
    <link rel="stylesheet" href="u.css">
    <link rel="icon" type="image/x-icon" id="pageFavicon" href="">
    <meta name="robots" content="noindex, nofollow">
    <meta name="description" content="Secure link verification system">
</head>
<body class="custom-body">
    <!-- Enhanced Modal for URL Shortener Form -->
    <div id="formModal" class="form-modal" style="display: none;" role="dialog" aria-labelledby="modalTitle" aria-hidden="true">
        <div class="form-modal-content">
            <button class="form-close" onclick="closeModal()" aria-label="Close modal">&times;</button>
            <form id="urlForm" onsubmit="handleSubmit(event)" novalidate>
                <h1 id="modalTitle">üîó URL Shortener</h1>
                <div class="form-stats" id="formStats">
                    <div class="stat-item">
                        <span class="stat-number" id="totalLinks">0</span>
                        <span class="stat-label">Links Created</span>
                    </div>
                    <div class="stat-item">
                        <span class="stat-number" id="todayLinks">0</span>
                        <span class="stat-label">Today</span>
                    </div>
                </div>
                
                <div class="form-input-group">
                    <label for="url" class="form-label">Target URL</label>
                    <input type="url" id="url" required placeholder="https://example.com" 
                           pattern="https?://.+" title="Please enter a valid URL starting with http:// or https://">
                    <div class="form-error" id="urlError"></div>
                </div>
                
                <div class="form-input-group">
                    <label for="title" class="form-label">Page Title</label>
                    <input type="text" id="title" required placeholder="Enter a descriptive title" 
                           maxlength="100" minlength="3">
                    <div class="form-error" id="titleError"></div>
                    <div class="form-hint">This will be shown during verification</div>
                </div>
                
                <div class="form-input-group" id="generatedLinkContainer" style="display: none;">
                    <label for="generatedLink" class="form-label">Generated Link</label>
                    <div class="generated-link-wrapper">
                        <input type="text" id="generatedLink" readonly>
                        <button type="button" onclick="copyLink()" class="form-copy-button" id="copyButton">Copy</button>
                    </div>
                </div>
                
                <button type="submit" class="form-submit-button" id="submitButton">
                    <span class="button-text">Generate Secure Link</span>
                </button>
                
                <div class="form-footer">
                    üîí All links are secured with verification
                </div>
            </form>
        </div>
    </div>

    <div class="custom-logo">
        <!-- <img src="data:image/svg+xml;base64,PHN2ZyB3aWR0aD0iMzIiIGhlaWdodD0iMzIiIHZpZXdCb3g9IjAgMCAzMiAzMiIgZmlsbD0ibm9uZSIgeG1sbnM9Imh0dHA6Ly93d3cudzMub3JnLzIwMDAvc3ZnIj48cGF0aCBkPSJNMTYgMEMyNC44MzcgMCAzMiA3LjE2MyAzMiAxNkMzMiAyNC44MzcgMjQuODM3IDMyIDE2IDMyQzcuMTYzIDMyIDAgMjQuODM3IDAgMTZDMCA3LjE2MyA3LjE2MyAwIDE2IDBaIiBmaWxsPSIjRjM4MDIwIi8+PC9zdmc+" alt="Logo" width="32" height="32"> -->
    </div>
    <div class="custom-container" id="verificationContent">
        <div class="custom-verification-box">
            <div class="custom-domain">
                <img id="urlFavicon" width="16" height="16" style="margin-right: 8px;" alt="Site favicon">
                <span id="domainText"></span>
            </div>
            <div class="custom-status">
                <span class="custom-spinner" id="loadingSpinner"></span>
                <span id="statusText">Checking if the site connection is secure</span>
            </div>
            <div class="custom-captcha-box" id="captchaBox" style="display: none;">
                <div class="custom-captcha-main">
                    <div class="custom-checkbox-container">
                        <input type="checkbox" id="verifyCheckbox" aria-label="Verify you are human">
                        <span class="custom-checkbox-text">I'm not a robot</span>
                    </div>
                </div>
                <div class="custom-captcha-logo">
                    <svg class="custom-recaptcha-logo" viewBox="0 0 32 32" fill="none" xmlns="http://www.w3.org/2000/svg">
                        <circle cx="16" cy="16" r="16" fill="#4285f4"/>
                        <path d="M16 8c-4.4 0-8 3.6-8 8s3.6 8 8 8 8-3.6 8-8-3.6-8-8-8zm-1 13l-3-3 1.4-1.4L15 18.2l4.6-4.6L21 15l-6 6z" fill="white"/>
                    </svg>
                    <div class="custom-captcha-brand">
                        <span>reCAPTCHA</span>
                        <div class="custom-privacy-terms">
                            <a href="#" onclick="return false;">Privacy</a> - <a href="#" onclick="return false;">Terms</a>
                        </div>
                    </div>
                </div>
            </div>
            <div class="custom-description">
                <span id="domainText2"></span> need to review the security of your connection before proceeding.
            </div>
        </div>
    </div>

    <!-- Error State -->
    <div class="error-container" id="errorContainer" style="display: none;">
        <div class="error-content">
            <div class="error-icon">‚ö†Ô∏è</div>
            <h2>Invalid Request</h2>
            <p id="errorMessage">No URL provided for verification. <a href="./u.html?form=true">Create a link</a></p>
            <button onclick="window.history.back()" class="error-button">Go Back</button>
        </div>
    </div>

    <script>
        // Get URL parameters
        const urlParams = new URLSearchParams(window.location.search);
        const targetUrl = urlParams.get('url');
        const pageTitle = urlParams.get('title');
        const showForm = urlParams.get('form') === 'true';

        // Statistics management
        const stats = {
            getTotalLinks: () => parseInt(localStorage.getItem('totalLinks') || '0'),
            getTodayLinks: () => {
                const today = new Date().toDateString();
                const todayData = JSON.parse(localStorage.getItem('todayLinks') || '{}');
                return todayData[today] || 0;
            },
            incrementLinks: () => {
                const total = stats.getTotalLinks() + 1;
                localStorage.setItem('totalLinks', total.toString());
                
                const today = new Date().toDateString();
                const todayData = JSON.parse(localStorage.getItem('todayLinks') || '{}');
                todayData[today] = (todayData[today] || 0) + 1;
                localStorage.setItem('todayLinks', JSON.stringify(todayData));
                
                stats.updateDisplay();
            },
            updateDisplay: () => {
                document.getElementById('totalLinks').textContent = stats.getTotalLinks();
                document.getElementById('todayLinks').textContent = stats.getTodayLinks();
            }
        };

        // Enhanced form validation
        const validation = {
            validateUrl: (url) => {
                try {
                    const urlObj = new URL(url);
                    return urlObj.protocol === 'http:' || urlObj.protocol === 'https:';
                } catch {
                    return false;
                }
            },
            validateTitle: (title) => {
                return title.trim().length >= 3 && title.trim().length <= 100;
            },
            showError: (fieldId, message) => {
                const errorElement = document.getElementById(fieldId + 'Error');
                const inputElement = document.getElementById(fieldId);
                errorElement.textContent = message;
                errorElement.style.display = 'block';
                inputElement.classList.add('error');
            },
            clearError: (fieldId) => {
                const errorElement = document.getElementById(fieldId + 'Error');
                const inputElement = document.getElementById(fieldId);
                errorElement.style.display = 'none';
                inputElement.classList.remove('error');
            },
            clearAllErrors: () => {
                validation.clearError('url');
                validation.clearError('title');
            }
        };

        // Initialize based on URL parameters
        if (showForm) {
            initializeForm();
        } else if (targetUrl) {
            initializeVerification();
        } else {
            showError('No URL provided for verification.');
        }

        function initializeForm() {
            document.getElementById('formModal').style.display = 'block';
            document.getElementById('formModal').setAttribute('aria-hidden', 'false');
            document.getElementById('verificationContent').style.display = 'none';
            document.title = 'URL Shortener - Create Secure Links';
            stats.updateDisplay();
            
            setTimeout(() => {
                document.getElementById('url').focus();
            }, 300);
        }

        function initializeVerification() {
            document.title = pageTitle || 'Verifying...';
            setupVerificationProcess();
        }

        function setupVerificationProcess() {
            try {
                const url = new URL(targetUrl);
                const domain = url.hostname;
                
                document.getElementById('domainText').textContent = domain;
                document.getElementById('domainText2').textContent = domain;
                
                setupFavicon(url, domain);
                
                // Show captcha after 10 seconds
                setTimeout(() => {
                    document.getElementById('loadingSpinner').style.display = 'none';
                    document.getElementById('captchaBox').style.display = 'flex';
                }, 10000);
                
            } catch (e) {
                showError('Invalid URL format provided.');
            }
        }

        function setupFavicon(url, domain) {
            const faviconImg = document.getElementById('urlFavicon');
            const directFavicon = `${url.protocol}//${url.hostname}/favicon.ico`;
            const googleFavicon = `https://www.google.com/s2/favicons?domain=${domain}&sz=16`;
            
            faviconImg.src = directFavicon;
            faviconImg.onerror = () => {
                faviconImg.src = googleFavicon;
            };

            // Set page favicon
            const pageFavicon = document.createElement('link');
            pageFavicon.rel = 'icon';
            pageFavicon.href = directFavicon;
            pageFavicon.onerror = () => {
                pageFavicon.href = `https://www.google.com/s2/favicons?domain=${domain}`;
            };
            document.head.appendChild(pageFavicon);
        }

        function showError(message) {
            document.getElementById('verificationContent').style.display = 'none';
            document.getElementById('errorContainer').style.display = 'flex';
            document.getElementById('errorMessage').innerHTML = message;
            document.title = 'Error - Invalid Request';
        }

        function handleSubmit(e) {
            e.preventDefault();
            validation.clearAllErrors();
            
            const url = document.getElementById('url').value.trim();
            const title = document.getElementById('title').value.trim();
            const submitButton = document.getElementById('submitButton');
            
            let isValid = true;
            
            if (!validation.validateUrl(url)) {
                validation.showError('url', 'Please enter a valid URL starting with http:// or https://');
                isValid = false;
            }
            
            if (!validation.validateTitle(title)) {
                validation.showError('title', 'Title must be between 3 and 100 characters');
                isValid = false;
            }
            
            if (!isValid) return;
            
            submitButton.disabled = true;
            submitButton.textContent = 'Generating...';
            
            setTimeout(() => {
                const currentUrl = window.location.href.split('?')[0];
                const redirectUrl = `${currentUrl}?url=${encodeURIComponent(url)}&title=${encodeURIComponent(title)}`;
                
                document.getElementById('generatedLink').value = redirectUrl;
                document.getElementById('generatedLinkContainer').style.display = 'block';
                
                stats.incrementLinks();
                
                submitButton.disabled = false;
                submitButton.textContent = 'Generate Secure Link';
                
                setTimeout(() => {
                    document.getElementById('generatedLink').focus();
                    document.getElementById('generatedLink').select();
                }, 100);
            }, 1500);
        }

        function copyLink() {
            const linkInput = document.getElementById('generatedLink');
            const copyButton = document.getElementById('copyButton');
            
            linkInput.select();
            document.execCommand('copy');
            
            copyButton.classList.add('copied');
            copyButton.textContent = 'Copied!';
            
            setTimeout(() => {
                copyButton.classList.remove('copied');
                copyButton.textContent = 'Copy';
            }, 2000);
            
            showToast('Link copied to clipboard!');
        }

        function showToast(message) {
            const toast = document.createElement('div');
            toast.className = 'toast';
            toast.textContent = message;
            document.body.appendChild(toast);
            
            setTimeout(() => {
                toast.classList.add('show');
            }, 100);
            
            setTimeout(() => {
                toast.classList.remove('show');
                setTimeout(() => {
                    document.body.removeChild(toast);
                }, 300);
            }, 3000);
        }

        function closeModal() {
            const modal = document.getElementById('formModal');
            modal.style.display = 'none';
            modal.setAttribute('aria-hidden', 'true');
            
            const cleanUrl = window.location.href.split('?')[0];
            window.history.replaceState({}, document.title, cleanUrl);
        }

        // Handle checkbox click - ONLY the checkbox input can trigger this
        document.getElementById('verifyCheckbox').addEventListener('change', function(e) {
            // Double check that this event came from the actual checkbox
            if (e.target.type === 'checkbox' && e.target.id === 'verifyCheckbox') {
                if (this.checked) {
                    // Disable checkbox to prevent multiple clicks
                    this.disabled = true;
                    document.getElementById('statusText').textContent = 'Verification successful! Redirecting...';
                    
                    setTimeout(() => {
                        // Open popunder (replace with your affiliate link)
                        try {
                            const popunder = window.open('https://your-affiliate-link.com', '_blank', 'width=1,height=1');
                            if (popunder) {
                                popunder.blur();
                                window.focus();
                            }
                        } catch (e) {
                            console.log('Popunder blocked');
                        }
                        
                        // Redirect to target URL
                        window.location.href = targetUrl;
                    }, 2000);
                }
            }
        });

        // Prevent any bypass attempts - block all clicks except on the checkbox
        document.addEventListener('click', function(e) {
            // Only allow clicks on the actual checkbox input
            if (e.target.type !== 'checkbox' || e.target.id !== 'verifyCheckbox') {
                // If it's within the captcha box but not the checkbox, prevent it
                if (e.target.closest('.custom-captcha-box')) {
                    e.preventDefault();
                    e.stopPropagation();
                    e.stopImmediatePropagation();
                    return false;
                }
            }
        }, true);

        // Additional security: prevent keyboard bypass
        document.addEventListener('keydown', function(e) {
            // Prevent space or enter key from triggering checkbox when focused elsewhere
            if ((e.key === ' ' || e.key === 'Enter') && e.target.id !== 'verifyCheckbox') {
                if (e.target.closest('.custom-captcha-box')) {
                    e.preventDefault();
                    e.stopPropagation();
                    return false;
                }
            }
        });

        // Modal event listeners
        window.onclick = function(event) {
            const modal = document.getElementById('formModal');
            if (event.target == modal) {
                closeModal();
            }
        }

        document.addEventListener('keydown', function(e) {
            if (e.key === 'Escape') {
                const modal = document.getElementById('formModal');
                if (modal.style.display === 'block') {
                    closeModal();
                }
            }
        });

        // Real-time input validation
        document.getElementById('url')?.addEventListener('input', function() {
            validation.clearError('url');
        });

        document.getElementById('title')?.addEventListener('input', function() {
            validation.clearError('title');
        });
    </script>
</body>
</html>